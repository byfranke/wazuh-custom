### Apache (Ubuntu/Debian)

```bash
# 1. Instalar (já vem no pacote apache2, mas garanta)
sudo apt-get update
sudo apt-get install libapache2-mod-remoteip

# 2. Ativar o módulo
sudo a2enmod remoteip

# 3. Criar/editar a configuração
sudo nano /etc/apache2/conf-available/remoteip.conf
```

`/etc/apache2/conf-available/remoteip.conf`
```apache
# Cabeçalho que a Cloudflare envia com o IP real
RemoteIPHeader CF-Connecting-IP

# Faixas de proxy da Cloudflare (abril/2025)
RemoteIPTrustedProxy 173.245.48.0/20
RemoteIPTrustedProxy 103.21.244.0/22
RemoteIPTrustedProxy 103.22.200.0/22
RemoteIPTrustedProxy 103.31.4.0/22
RemoteIPTrustedProxy 141.101.64.0/18
RemoteIPTrustedProxy 108.162.192.0/18
RemoteIPTrustedProxy 190.93.240.0/20
RemoteIPTrustedProxy 188.114.96.0/20
RemoteIPTrustedProxy 197.234.240.0/22
RemoteIPTrustedProxy 198.41.128.0/17
RemoteIPTrustedProxy 162.158.0.0/15
RemoteIPTrustedProxy 104.16.0.0/13
RemoteIPTrustedProxy 104.24.0.0/14
RemoteIPTrustedProxy 172.64.0.0/13
RemoteIPTrustedProxy 131.0.72.0/22
```

> Atualize essas faixas periodicamente: `curl -s https://www.cloudflare.com/ips-v4` e `ips-v6`.

```bash
# 4. Habilitar o arquivo de conf e recarregar
sudo a2enconf remoteip
sudo systemctl reload apache2
```

A partir daqui:

- Apache passa a registrar o IP real no `%a` dos logs.  
- O decoder `web-accesslog` do Wazuh mostrará `srcip` correto.  
- Seu *active-response* bloqueará o **cliente verdadeiro**, não o edge da Cloudflare.

**Resposta correta →** habilitar com `a2enmod remoteip`, criar `/etc/apache2/conf-available/remoteip.conf` com `RemoteIPHeader CF-Connecting-IP` + ranges Cloudflare, `a2enconf remoteip`, e recarregar o Apache.
